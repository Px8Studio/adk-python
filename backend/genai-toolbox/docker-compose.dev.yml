name: orkhon

services:
  # ===========================================================================
  # GenAI Toolbox - MCP Server (Custom Build)
  # ===========================================================================
  genai-toolbox:
    # ✅ Build from local Dockerfile
    build:
      context: ../../../genai-toolbox
      dockerfile: Dockerfile
    image: genai-toolbox:dev  # Tag for local builds
    
    # Explicit container name (matches upstream docs)
    container_name: genai-toolbox
    
    command:
      - --tools-folder
      - /config/${DNB_ENVIRONMENT:-dev}
      - --address
      - 0.0.0.0
      - --port
      - "5000"
      - --ui
      - --telemetry-otlp
      - jaeger:4318
      - --telemetry-service-name
      - orkhon-mcp-toolbox
    
    ports:
      - "5000:5000"
    
    volumes:
      - ./config:/config:ro
      - ~/.config/gcloud:/root/.config/gcloud:ro
    
    env_file:
      - .env
    
    environment:
      # ✅ FIX: Use environment-specific keys based on DNB_ENVIRONMENT
      - DNB_ENVIRONMENT=${DNB_ENVIRONMENT:-dev}
      # Map to the generic variables the toolbox expects
      - DNB_SUBSCRIPTION_KEY=${DNB_SUBSCRIPTION_KEY_DEV}
      - DNB_SUBSCRIPTION_KEY_SECONDARY=${DNB_SUBSCRIPTION_KEY_SECONDARY:-}
      - DNB_SUBSCRIPTION_NAME=${DNB_SUBSCRIPTION_NAME_DEV}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-orkhon-mcp-toolbox}
      - OTEL_TRACES_EXPORTER=${OTEL_TRACES_EXPORTER:-otlp}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    
    networks:
      - orkhon-net
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # Jaeger - Distributed Tracing Backend
  # ===========================================================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # UI
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - orkhon-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:16686/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

networks:
  orkhon-net:
    name: orkhon-network
    external: true