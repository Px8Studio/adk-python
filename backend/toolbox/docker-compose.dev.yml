name: orkhon-toolbox-dev

services:
  # ===========================================================================
  # GenAI Toolbox - MCP Server (Google's Implementation)
  # ===========================================================================
  genai-toolbox-mcp:
    image: genai-toolbox:latest  # Use local image
    # container_name: orkhon-genai-toolbox-mcp  # removed to avoid global name conflicts
    # Let the image's ENTRYPOINT run the binary; only pass flags here
    command:
      - --tools-folder
      - /config/${DNB_ENVIRONMENT:-dev}
      - --address
      - 0.0.0.0
      - --port
      - "5000"
      - --ui
      - --telemetry-otlp
      # NOTE: endpoint must be host:port (no scheme). e.g., "jaeger:4318"
      # Use a dedicated var to avoid accidentally passing "http://..."
      - ${OTEL_COLLECTOR_HOSTPORT:-jaeger:4318}
      - --telemetry-service-name
      - ${OTEL_SERVICE_NAME}
      - --log-level
      - info
    ports:
      - "5000:5000"
    volumes:
      - ./config:/config:ro
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DNB_ENVIRONMENT=${DNB_ENVIRONMENT:-dev}
      - DNB_SUBSCRIPTION_KEY_DEV=${DNB_SUBSCRIPTION_KEY_DEV}
      - DNB_SUBSCRIPTION_KEY_PROD=${DNB_SUBSCRIPTION_KEY_PROD}
      - DNB_SUBSCRIPTION_NAME_DEV=${DNB_SUBSCRIPTION_NAME_DEV}
      - DNB_SUBSCRIPTION_NAME_PROD=${DNB_SUBSCRIPTION_NAME_PROD}
      # Ensure no scheme in this value (jaeger:4318). Used only for the flag above.
      - OTEL_COLLECTOR_HOSTPORT=${OTEL_COLLECTOR_HOSTPORT:-jaeger:4318}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME}
      - OTEL_TRACES_EXPORTER=${OTEL_TRACES_EXPORTER:-otlp}
      - OTEL_METRICS_EXPORTER=none  # Already set âœ…
      - OTEL_LOGS_EXPORTER=none
    networks:
      - orkhon-net
    depends_on:
      jaeger:
        condition: service_healthy

  # ===========================================================================
  # Jaeger - Distributed Tracing (OpenTelemetry Backend)
  # ===========================================================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    # container_name: orkhon-jaeger  # keep removed
    ports:
      - "16686:16686"
      - "4318:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - orkhon-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  orkhon-net:
    name: orkhon-network
    external: true